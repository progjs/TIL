# Docker



#### Docker

컨테이너 기반의 오픈소스 가상화 플랫폼

서버에서 다양한 프로그램, 실행환경을 **컨테이너**로 추상화하고 동일한 인터페이스를 제공하여 **프로그램 배포 및 관리를 단순하게** 해준다.

##### 컨테이너(Container)

​	격리된 공간에서 프로세스가 동작하는 기술



### 가상화의 변화

##### 기존 가상화 방식

- VMware, VirtualBox 등
- 호스트 OS 위에 게스트 OS 전체를 가상화하여 사용
- 단점: 무겁고 느려서 운영환경에선 사용할 수 없다.

##### 향상된 가상화 방식

- KVM, 반가상화 방식의 Xen
- 게스트 OS에 전체 OS를 가상화하는 방식이 아니므로, 성능 향상

##### Docker

- 추가적인 OS 설치 없이 프로세스를 격리하는 방식
- 리눅스 - 리눅스 컨테이너
- CPU와 메모리를 프로세스가 필요한 만큼만 추가로 사용하여, 가볍고 빠르게 동작한다.



### Docker

- 실행중인 컨테이너에 접속해, 명령어를 입력
- `apt-get` 이나 `yum`으로 패키지 설치
- 사용자 추가 가능
- 여러 개의 프로세스를 백그라운드에서 실행 가능
- CPU나 메모리 사용량 제한 가능
- 호스트의 포트와 연결하여 호스트의 특정 directory를 내부에서 사용 가능



### Image (이미지)

- 컨테이너 실행에 필요한 파일, 설정값 등을 포함하는 것

- immutable (변하지 않는다) 

- 이미지 : 컨테이너 = 1 : N 가능

- **의존성 파일을 컴파일해야 할 필요 없다**

- Docker hub에 등록하거나 Docker registry 저장소에서 관리 가능 (update, 배포)

  

  **이미지 명령어**

  - 이미지 목록 확인 `docker images`

  - 이미지 다운로드 `docker pull 사용자명/이미지명:태그명`

    `run` 명령어로도 다운로드 가능하지만,

    `pull`은 이미 다운받은 이미지를 최신버전으로 업데이트한다.

  - 이미지 삭제 `docker rmi image 이미지`



#### 레이어 (Layer)

- docker image는 용량이 크기 때문에, 유니온 파일 시스템을 사용한다
- image 하나는 여러개의 layer로 구성된다
- image 에 파일이 추가/수정되면 새로운 layer가 생성된다.



#### Dockerfile

- docker 이미지를 생성하기 위해 DSL언어로 **이미지 생성 과정**을 담은 파일
- Docker hub에서 소스와 버전관리가 가능



### Container (컨테이너) 명령어

| 옵션   | 설명                                     |
| ------ | ---------------------------------------- |
| -d     | 백그라운드 모드                          |
| -p     | 호스트-컨테이너 포트 연결 (포트포워딩)   |
| -v     | 호스트-컨테이너의 디렉토리 연결 (마운트) |
| -e     | 컨테이너 내 환경변수 설정                |
| -name  | 컨테이너 이름                            |
| -rm    | 프로세스 종료할 때, 컨테이너도 함께 제거 |
| -it    | -i + -t (터미널 입력)                    |
| --link | 컨테이너 연결                            |

- 컨테이너 목록 확인 `docker ps`

- 컨테이너 중지 `docker stop container 컨테이너` 

- 컨테이너 제거 `docker rm container 컨테이너`

  - 중지된 컨테이너 모두 제거 `docker rm -v $(docker ps -a -q -f status=exited)`

- 컨테이너 로그 보기 `docker --tail 10 logs 컨테이너`

  마지막 10줄의 컨테이너 로그만 보기

- 컨테이너 명령어 실행 `docker exec -it 컨테이너 명령어`



#### 컨테이너 update 방식

1. 새로운 버전의 이미지를 다운`pull`받고 

2. 기존 컨테이너를 삭제 `stop rm`하고

3. 새 이미지를 기반으로 새로운 컨테이너를 실행`run`한다

- **주의사항**

  컨테이너를 삭제하면 내부 모든 파일이 삭제된다

  => 컨테이너에 저장할 데이터를 컨테이너 dir 외부에 저장하도록 설정해야 한다.

  => **클라우드 서비스** 나 **볼륨**을 컨테이너에 매칭해서 사용해야 한다.



#### 볼륨(data volume)

> **영속성**
>
> 해당 디렉토리는 컨테이너와 별개로 저장되어, 컨테이너를 삭제해도 데이터를 유지한다. 

##### 볼륨 사용법 : 호스트의 디렉토리를 마운트

1. 호스트 디렉토리 - 컨테이너 디렉토리 마운트

   ```
   docker run -d -p 3306:3306 -e MYSQL_PASSWORD=password --name mysql
   -v /home/own/datadir:/var/lib/mysql mysql:5.7
   ```

   호스트 디렉토리 `/home/own/datadir`와 컨테이너 디렉토리 `/var/lib/mysql` 를 마운트

2. 최신버전의 이미지를 다운받고`pull` 다시 새 컨테이너를 생성해서 실행할 때

   동일한 디렉토리를 마운트한다.

   => 기존의 데이터를 그대로 사용 가능



------



#### docker에서 build는?

Dockerfile에 명시된 명령어를 다음의 순서대로 수행한다.

1. 임시 컨테이너 생성
2. 명령어 수행
3. 이미지로 저장
4. 임시 컨테이너 제거
5. 새로 만든 이미지를 기반으로 컨테이너 생성
6. 2번부터 다시 반복

build를 반복할 때마다 변경된 Dockerfile의 명령어를 실행해 **이미지 레이어**로 저장한다.

만약 Dockerfile의 변경사항이 없다면 저장해두었던 이미지를 그대로 사용한다.



#### Base Image

docker 이미지를 다운로드할 때, 베이스 이미지를 활용하는 것이 편하다.

```
FROM ruby:2.3
```

- 베이스 이미지를 사용하지 않았을 때

  ```
  FROM ubuntu:16.04
  RUN apt-get -y update
  RUN apt-get -y install ruby
  RUN gem install bundler
  ```

  